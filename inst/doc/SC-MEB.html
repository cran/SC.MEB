<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>SC-MEB</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">SC-MEB</h1>



<div id="install-the-sc.meb" class="section level2">
<h2>Install the SC.MEB</h2>
<p>This vignette provides an introduction to the R package <code>SC.MEB</code>, where the function <code>SC.MEB</code> implements the model <code>SC-MEB</code>, spatial clustering with hidden Markov random field using empirical Bayes. The package can be installed with the command:</p>
<p><code>library(devtools)</code></p>
<p><code>install_github(&quot;Shufeyangyi2015310117/SC.MEB&quot;)</code></p>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(<span class="st">&quot;SC.MEB&quot;</span>)</span></code></pre></div>
</div>
<div id="fit-sc-meb-using-simulated-data" class="section level2">
<h2>Fit SC-MEB using simulated data</h2>
<div id="generating-the-simulated-data" class="section level3">
<h3>Generating the simulated data</h3>
<p>We first set the basic parameter:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">library</span>(mvtnorm)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">library</span>(GiRaF)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">library</span>(SingleCellExperiment)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a>G &lt;-<span class="st"> </span><span class="dv">4</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>Bet &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>KK &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>p &lt;-<span class="st"> </span><span class="dv">15</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>mu &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>( <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>, <span class="kw">rep</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="dv">14</span>)),</span>
<span id="cb2-10"><a href="#cb2-10"></a>               <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">15</span>),</span>
<span id="cb2-11"><a href="#cb2-11"></a>               <span class="kw">c</span>(<span class="dv">6</span>, <span class="kw">rep</span>(<span class="fl">1.5</span>, <span class="dv">14</span>)),</span>
<span id="cb2-12"><a href="#cb2-12"></a>               <span class="kw">c</span>(<span class="kw">rep</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="dv">7</span>), <span class="kw">rep</span>(<span class="fl">1.5</span>, <span class="dv">7</span>), <span class="dv">6</span>),</span>
<span id="cb2-13"><a href="#cb2-13"></a>               <span class="kw">c</span>(<span class="kw">rep</span>(<span class="fl">1.5</span>, <span class="dv">7</span>), <span class="kw">rep</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="dv">7</span>), <span class="dv">-6</span>)), <span class="dt">ncol =</span> KK)</span>
<span id="cb2-14"><a href="#cb2-14"></a>height &lt;-<span class="st"> </span><span class="dv">70</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>width &lt;-<span class="st"> </span><span class="dv">70</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>n &lt;-<span class="st"> </span>height <span class="op">*</span><span class="st"> </span>width <span class="co"># # of cell in each indviduals</span></span></code></pre></div>
<p>Then, we generate the true clustering label, 15-dimensional PCA and position of each spot.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>X &lt;-<span class="st"> </span><span class="kw">sampler.mrf</span>(<span class="dt">iter =</span> n, <span class="dt">sampler =</span> <span class="st">&quot;Gibbs&quot;</span>, <span class="dt">h =</span> height, <span class="dt">w =</span> width, <span class="dt">ncolors =</span> KK, <span class="dt">nei =</span> G, <span class="dt">param =</span> Bet,<span class="dt">initialise =</span> <span class="ot">FALSE</span>, <span class="dt">view =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>x &lt;-<span class="st"> </span><span class="kw">c</span>(X) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>y &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> n, <span class="dt">ncol =</span> p)</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n)   { <span class="co"># cell</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  mu_i &lt;-<span class="st"> </span>mu[, x[i]]</span>
<span id="cb3-7"><a href="#cb3-7"></a>  Sigma_i &lt;-<span class="st"> </span>((x[i]<span class="op">==</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>(x[i]<span class="op">==</span><span class="dv">2</span>)<span class="op">*</span><span class="fl">2.5</span> <span class="op">+</span><span class="st"> </span>(x[i]<span class="op">==</span><span class="dv">3</span>)<span class="op">*</span><span class="dv">3</span> <span class="op">+</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="st">                </span>(x[i]<span class="op">==</span><span class="dv">4</span>)<span class="op">*</span><span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>(x[i]<span class="op">==</span><span class="dv">5</span>)<span class="op">*</span><span class="dv">4</span>)<span class="op">*</span><span class="kw">diag</span>(<span class="dv">1</span>, p)<span class="op">*</span><span class="fl">0.3</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>  y[i, ] &lt;-<span class="st"> </span><span class="kw">rmvnorm</span>(<span class="dv">1</span>, mu_i, Sigma_i)</span>
<span id="cb3-10"><a href="#cb3-10"></a>}</span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a>pos &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>height, width), <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>height, <span class="dt">each=</span>width))</span></code></pre></div>
<p>Subsequently, we construct the SingleCellExperiment object based on the above PCA and position.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># make SC-MEB metadata used in SC-MEB</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>counts &lt;-<span class="st"> </span><span class="kw">t</span>(y)</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">rownames</span>(counts) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;gene_&quot;</span>, <span class="kw">seq_len</span>(p))</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">colnames</span>(counts) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;spot_&quot;</span>, <span class="kw">seq_len</span>(n))</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">## Make array coordinates - filled rectangle</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>cdata &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb4-9"><a href="#cb4-9"></a>nrow &lt;-<span class="st"> </span>height; ncol &lt;-<span class="st"> </span>width</span>
<span id="cb4-10"><a href="#cb4-10"></a>cdata<span class="op">$</span>row &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq_len</span>(nrow), <span class="dt">each=</span>ncol)</span>
<span id="cb4-11"><a href="#cb4-11"></a>cdata<span class="op">$</span>col &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq_len</span>(ncol), nrow)</span>
<span id="cb4-12"><a href="#cb4-12"></a>cdata &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(cbind, cdata))</span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">## Scale and jitter image coordinates</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#scale.factor &lt;- rnorm(1, 8);  n_spots &lt;- n</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#cdata$imagerow &lt;- scale.factor * cdata$row + rnorm(n_spots)</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">#cdata$imagecol &lt;- scale.factor * cdata$col + rnorm(n_spots)</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>cdata<span class="op">$</span>imagerow &lt;-<span class="st"> </span>cdata<span class="op">$</span>row</span>
<span id="cb4-18"><a href="#cb4-18"></a>cdata<span class="op">$</span>imagecol &lt;-<span class="st"> </span>cdata<span class="op">$</span>col</span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co">## Make SCE</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co">## note: scater::runPCA throws warning on our small sim data, so use prcomp</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>sce &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="dt">assays=</span><span class="kw">list</span>(<span class="dt">counts=</span>counts), <span class="dt">colData=</span>cdata)</span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="kw">reducedDim</span>(sce, <span class="st">&quot;PCA&quot;</span>) &lt;-<span class="st"> </span>y</span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co"># sce$spatial.cluster &lt;- floor(runif(ncol(sce), 1, 3))</span></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="kw">metadata</span>(sce)<span class="op">$</span>SCMEB.data &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="kw">metadata</span>(sce)<span class="op">$</span>SCMEB.data<span class="op">$</span>platform &lt;-<span class="st"> &quot;ST&quot;</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="kw">metadata</span>(sce)<span class="op">$</span>SCMEB.data<span class="op">$</span>is.enhanced &lt;-<span class="st"> </span><span class="ot">FALSE</span></span></code></pre></div>
</div>
<div id="fitting-the-sc-meb" class="section level3">
<h3>Fitting the SC-MEB</h3>
<p>Here, we set the basic paramters for our function <code>SC.MEB</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>platform =<span class="st"> &quot;ST&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>beta_grid =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">4</span>,<span class="fl">0.2</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a>K_set=<span class="st"> </span><span class="dv">2</span><span class="op">:</span><span class="dv">10</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>parallel=<span class="ot">TRUE</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>num_core =<span class="st"> </span><span class="dv">3</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>PX =<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>maxIter_ICM =<span class="st"> </span><span class="dv">10</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>maxIter =<span class="st"> </span><span class="dv">50</span></span></code></pre></div>
<p>Here, we briefly explain these parameters.</p>
<p>‘parallel’ is a logical value specifing the run the model in parallel. The default is TRUE.</p>
<p>‘num_core’ is a interger value for the number of cores used for parallel. The default is 5.</p>
<p>‘PX’ is a logical value for paramter expansion in EM algorithm. The default is True.</p>
<p>‘K_set’ is an integer vector specifying the numbers of mixture components (clusters) for which the BIC is to be calculated. The default is K = 2:10.</p>
<p>‘platform’ is the name of spatial transcriptomic platform. Specify ‘Visium’ for hex lattice geometry or ‘ST’ for square lattice geometry. Specifying this parameter is optional as this information is included in their metadata.</p>
<p>‘beta_grid’ is a numeric vector specifying the smoothness of Random Markov Field. The default is seq(0,5,0.2).</p>
<p>‘maxIter_ICM’ is the maximum iteration of ICM algorithm. The default is 10.</p>
<p>‘maxIter’ is the maximum iteration of EM algorithm. The default is 50.</p>
<div id="calculating-the-neighborhood" class="section level4">
<h4>Calculating the neighborhood</h4>
<p>First, we require to find the neighborhood</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>Adj_sp &lt;-<span class="st"> </span><span class="kw">getneighborhood_fast</span>(<span class="kw">as.matrix</span>(pos), <span class="dt">cutoff =</span> <span class="fl">1.2</span>)</span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>Adj_sp &lt;-<span class="st"> </span><span class="kw">find_neighbors2</span>(sce, <span class="dt">platform =</span> platform)</span>
<span id="cb7-2"><a href="#cb7-2"></a>Adj_sp[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</span></code></pre></div>
<p>The output ‘Adj_sp’ is a sparse matrix to describe the neighorhood. There two functions are both used to calculate the nrighborhood. The first function ‘getneighobrhood_fast’ is a general function used for general data. However, the second function ‘find_neighbors2’ is a specific function for ST and Visium data.</p>
</div>
<div id="run-the-sc-meb-in-parallel" class="section level4">
<h4>Run the SC-MEB in parallel</h4>
<p>Finally, we run our model <code>SC-MEB</code> by the function <code>SC.MEB</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>fit =<span class="st"> </span><span class="kw">SC.MEB</span>(y, Adj_sp, <span class="dt">beta_grid =</span> beta_grid, <span class="dt">K_set=</span> K_set, <span class="dt">parallel=</span>parallel, <span class="dt">num_core =</span> num_core, <span class="dt">PX =</span> PX, <span class="dt">maxIter_ICM=</span>maxIter_ICM, <span class="dt">maxIter=</span>maxIter)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">str</span>(fit[,<span class="dv">1</span>])</span></code></pre></div>
<p>Here, We briefly explain the output of the <code>SC.MEB</code>.</p>
<p>The item ‘x’ is clustering label.</p>
<p>The item ‘ell’ is the opposite log-likelihood for each beta and K.</p>
<p>The item ‘mu’ is the mean of each component.</p>
<p>The item ‘sigma’ is the variance of each component.</p>
<p>The item ‘gam’ is the posterior probability.</p>
<p>The item ‘beta’ is the estimated smoothing parameter.</p>
</div>
</div>
<div id="clustering" class="section level3">
<h3>Clustering</h3>
<div id="selecting-the-number-of-clusters-using-bic" class="section level4">
<h4>Selecting the number of clusters using BIC</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">selectKPlot</span>(fit, <span class="dt">K_set =</span> K_set, <span class="dt">criterion =</span> <span class="st">&quot;BIC&quot;</span>)</span></code></pre></div>
</div>
<div id="selecting-the-number-of-clusters-using-modified-bic" class="section level4">
<h4>Selecting the number of clusters using Modified BIC</h4>
<p>Here we briefly explain how to choose the parameter c in the modified BIC. In general, For the ST or Visium dataset, it often ranges from 0.4 to 1 while for the MERFISH dataset with large number of cells, it often becomes larger, for example 10,20. Most importantly, SC-MEB is fast, scaling well in terms of sample size, which allow the user to tune the c based on their prior knowledge about the tissues or cells.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">selectKPlot</span>(fit, <span class="dt">K_set =</span> K_set, <span class="dt">criterion =</span> <span class="st">&quot;MBIC&quot;</span>)</span></code></pre></div>
</div>
<div id="visualizing-spatial-clusters" class="section level4">
<h4>Visualizing spatial clusters</h4>
<p>We can plot the cluster assignments over the spatial locations of the spots with ClusterPlot().</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>out =<span class="st"> </span><span class="kw">selectK</span>(fit, <span class="dt">K_set =</span> K_set, <span class="dt">criterion =</span> <span class="st">&quot;BIC&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">ClusterPlot</span>(out, pos)</span></code></pre></div>
<p>As ClusterPlot() returns a ggplot object, it can be customized by composing with familiar ggplot2 functions.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">ClusterPlot</span>(out, pos) <span class="op">+</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">xlab</span>(<span class="st">&quot;Row&quot;</span>) <span class="op">+</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="kw">ylab</span>(<span class="st">&quot;Column&quot;</span>) <span class="op">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">&quot;Spatial clustering&quot;</span>)</span></code></pre></div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
